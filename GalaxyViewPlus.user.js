// ==UserScript==
// @name        GalaxyViewPlus
// @description I hab scho mit 3 im Wald mid mein Vadder usernamne gefärbdne und Ränggne gschriebne
// @version     1.2.1
// @author      Architekt Apx aka. Dr. Architekt1510, Altschauerberg 8, 91448 Emskirchen
// @homepage    https://github.com/ArchitektApx/GalaxyViewPlus
// @match       https://pr0game.com/*/game.php?*page=galaxy*
// @connect     pr0game.com
// @downloadURL https://raw.githubusercontent.com/ArchitektApx/GalaxyViewPlus/master/GalaxyViewPlus.user.js
// @grant       GM_addStyle
// @grant       GM.xmlHttpRequest
// @updateURL   https://raw.githubusercontent.com/ArchitektApx/GalaxyViewPlus/master/GalaxyViewPlus.user.js
// ==/UserScript==

(()=>{"use strict";class e{static DEBUG="debug";static ERROR="error";static INFO="info";static WARN="warn"}class t{static defaultTo(e,a=""){return t.isSomething(e)?e:a}static forceArray(e){return Array.isArray(e)?e:[e]}static hasZeroLength({length:e}){return 0===e}static isArrayOrObject(e){return Array.isArray(e)||t.isType(e,{})}static isEmptyArray(e){return Array.isArray(e)&&t.hasZeroLength(e)}static isEmptyObject(e){return"object"==typeof e&&t.hasZeroLength(Object.keys(e))&&e.constructor===Object}static isNullOrEmptyString(e){return null==e||"string"==typeof e&&""===e.trim()}static isSomething(e){return!!e&&!t.isEmptyArray(e)&&!t.isEmptyObject(e)}static isThisAndThat(e,t,a){return e===t&&e===a}static isThisOrThat(e,t,a){return e===t||e===a}static isThisOrThatType(e,a,s){return t.isType(e,a)||t.isType(e,s)}static isType(e,a){return t.isThisOrThat(e,null)||t.isThisOrThat(a,null)?e===a:e.constructor===a.constructor}static pathFromKeys(e){let t="";return e.forEach(((e,a)=>{t+="number"==typeof e?`[${e}]`:(a?".":"")+e})),t}static pathToKeys(e){if("string"!=typeof e)throw new TypeError("Path must be a string.");const t=[];return e.split(".").forEach((e=>{if(e.includes("[")){const[a,...s]=e.split("[");t.push(a,...s.map((e=>e.replace("]",""))))}else t.push(e)})),t}static prepareInput(e,a=!1){return a&&"object"==typeof e&&null!==e?Object.entries(e):t.forceArray(t.defaultTo(e,[]))}}class a{static arrayAction(e,a,s,n=!1){const r=t.prepareInput(a,n);if("function"!=typeof r[e])throw new TypeError(`Unsupported action: ${e}`);return r[e](s)}static filterAny(e,t,s=!1){return a.arrayAction("filter",e,t,s)}static findAny(e,t,s=!1){return a.arrayAction("find",e,t,s)}static forAny(e,t,s=!1){return a.arrayAction("forEach",e,t,s)}static mapAny(e,t,s=!1){return a.arrayAction("map",e,t,s)}}class s{static deepClone(e){return JSON.parse(JSON.stringify(e))}static getNestedValueOrDefault(e,a,s){const n=t.pathToKeys(a),r=(e,t)=>{if(0===t.length)return e;const a=t[0];return Object.hasOwnProperty.call(e,a)?r(e[a],t.slice(1)):s};return r(e,n)}static hasThisAndThatProp(e,t,a){return Object.keys(e).includes(t)&&Object.keys(e).includes(a)}static hasThisOrThatProp(e,t,a){return Object.keys(e).includes(t)||Object.keys(e).includes(a)}static mergeObjects(e,t){return{...e,...t}}static setNestedValue(e,a,s){const n=t.pathToKeys(a);let r=e;n.slice(0,-1).forEach(((e,a)=>{if(!t.isType(r[e],{})){const t=n[a+1];r[e]=r[e]||(/^\d+$/.test(t)?[]:{})}r=r[e]})),r[n.at(-1)]=s}}class n{static{[t,a,s].forEach((e=>{Object.getOwnPropertyNames(e).filter((t=>!["length","prototype","name","constructor"].includes(t)&&"function"==typeof e[t])).forEach((t=>{n[t]=e[t].bind(e)}))}))}}class r{static CLEANUP_INTERVAL=168;static DEBUG_LOG_MAX_ENTRIES=20;static DEFAULT_CONFIG={configVersion:"1.0.5",features:[{active:!0,dataType:"ValueTable",description:"Färbt den Usernamen des Users ein.",displayName:"Usernamen Färben",feature:"userRecolor",htmlPrefix:"userRecolor",keyDefault:"BeispielUserName",keyDescription:"Der Username des Users",keyDisplayName:"Username",keyInputType:"text",keyName:"Username",sortData:!0,valueDefault:"#ffa700",valueDescription:"Die Farbe welche für den Usernamen verwendet wird",valueDisplayName:"Farbe",valueInputType:"color",valueName:"Farbe",data:[{key:"BeispielUserName",value:"#ffa700"}]},{active:!0,dataType:"ValueTable",description:"Färbt den Rank des Users ein.",displayName:"Rank Färben",feature:"rankRecolor",htmlPrefix:"rankRecolor",keyDefault:0,keyDescription:"Der Rang ab welchem die Farbe angewant wird",keyDisplayName:"Rank",keyInputType:"number",keyName:"Rank",sortData:!0,valueDefault:"#2cba00",valueDescription:"Die Farbe welche für den Rang verwendet wird",valueDisplayName:"Farbe",valueInputType:"color",valueName:"Farbe",data:[{key:0,value:"#2cba00"},{key:200,value:"#a3ff00"},{key:500,value:"#fff400"},{key:600,value:"#ffa700"},{key:700,value:"#ff0000"}]},{active:!1,dataType:"ValueList",description:"Färbt inaktive User ein.",displayName:"Inaktive Färben",feature:"inactiveRecolor",htmlPrefix:"inactiveRecolor",data:[{displayName:"Inaktiv (i)",inputType:"color",key:"inactiveColor",value:"#f70fff",valueDescription:"Inaktiv (i)"},{displayName:"Lange i (i l)",inputType:"color",key:"longInactiveColor",value:"#ff00ff",valueDescription:"Lange Inaktiv (i l)"}]},{active:!0,dataType:"ValueList",description:"Zeigt die Anzahl der Planeten/Monde im Umkreis des aktuellen Systems an. Achtung: funktioniert nur wenn Planeten/Mond Infos durch Syncs/Json/CSV vorhanden sind!",displayName:"RangeInfo",feature:"rangeInfo",htmlPrefix:"rangeInfo",data:[{displayName:"Radius",inputType:"number",key:"nearRange",value:20,valueDescription:"Anzahl der System vor/nach dem aktuellen welche überprüft werden."},{displayName:"Min. Sys.",inputType:"number",key:"minSys",value:1,valueDescription:"Das erste System in der Galaxy. Mach etzadla kein Unfug häddix8 ghabt!"},{displayName:"Max. Sys.",inputType:"number",key:"maxSys",value:400,valueDescription:"Das letzte System in der Galaxy. Mach etzadla kein Unfug häddix8 ghabt!"}]},{active:!1,dataType:"ValueList",description:"Verändert den Rang welcher im Galaxy View angezeigt wird",displayName:"Rangtyp (für Rank färben) wählen",feature:"rankSelector",htmlPrefix:"rankSelector",data:[{checked:!0,displayName:"Gesamt",inputType:"radio",key:"rankSelect",value:"rank",valueDescription:"rankSelect"},{checked:!1,displayName:"Gebäude",inputType:"radio",key:"rankSelect",value:"buildingRank",valueDescription:"rankSelect"},{checked:!1,displayName:"Forschung",inputType:"radio",key:"rankSelect",value:"researchRank",valueDescription:"rankSelect"},{checked:!1,displayName:"Flotte",inputType:"radio",key:"rankSelect",value:"fleetRank",valueDescription:"rankSelect"},{checked:!1,displayName:"Verteidigung",inputType:"radio",key:"rankSelect",value:"defensiveRank",valueDescription:"rankSelect"}]},{active:!0,dataType:"ValueList",description:"Einstellungen die sich nicht auf Spieler sondern das Skript ansich beziehen.",displayName:"Generelle Einstellungen",feature:"generalsettings",htmlPrefix:"generalsettings",data:[{checked:!0,displayName:"Sync shortcut auf E",inputType:"checkbox",key:"syncbutton",value:"syncbutton",valueDescription:"Shortcut der den Sync Button auf die e-Taste legt"},{checked:!0,displayName:"Debug Infos anzeigen",inputType:"checkbox",key:"debugInfo",value:"debugInfo",valueDescription:"Zeigt Informationen über das Script an"},{checked:!0,displayName:"Debug Log anzeigen",inputType:"checkbox",key:"debugLog",value:"debugLog",valueDescription:"Zeigt Log Informationen der Module an"},{checked:!1,displayName:"Config offen halten",inputType:"checkbox",key:"configOpen",value:"configOpen",valueDescription:"Öffnet die Config beim Start"}]}],userInterface:{css:'\n                .settings-interface-wrapper {\n                    margin-top: 10px;\n                    margin-bottom: 10px;\n                    width: 100%;\n                }\n\n                .feature-settings-container {\n                    width: calc(50% - 20px);\n                    margin-left: 10px;\n                    margin-right: 10px;\n                    display: inline-block;\n                    vertical-align: top;\n                }\n\n                .feature-header-title {\n                  font-weight: bold;\n                }\n\n                .feature-header-container {\n                  margin-bottom: 10px;\n                }\n\n                .feature-header-container label,\n                .feature-header-container input[type="checkbox"] {\n                  display: inline-block;\n                  vertical-align: top; /* Align label and checkbox at the top of their line */\n                }\n\n                .feature-header-container label:nth-of-type(1)\n                .feature-header-container input[type="checkbox"]:nth-of-type(1) {\n                  float: left;\n                }\n\n                .feature-header-container label:nth-of-type(2){\n                  clear: left;\n                  margin-left: 5%;\n                }\n\n                .feature-header-container p,\n                .feature-header-container label {\n                  text-align: left;\n                }\n\n                .feature-header-container label {\n                    width: 20%;\n                }\n\n                .feature-body-container {\n                    width: 80%;\n                }\n\n                .feature-body-container table {\n                    width: 100%;\n                }\n\n                .feature-body-container button {\n                    margin-top: 10px;\n                }\n\n                .ValueList-row {\n                    margin-bottom: 10px;\n                }\n\n                .ValueList-row label {\n                    display: inline-block;\n                }\n\n                .hidden {\n                    display: none;\n                }\n\n                #settings-interface-footer {\n                    margin-top: 20px;\n                    width: 100%;\n                    text-align: center;\n                } \n                ',title:"Galaxy View Plus Config"}};static STORAGE_KEYS={CLEANUP_STATUS:"GalaxyViewPlus_CleanupStatus",DEBUG_LOG:"GalaxyViewPlus_DebugLog",STATS_DATA:"GalaxyViewPlus_StatsData",UPDATE_STATUS:"GalaxyViewPlus_UpdateStatus",USER_CONFIG:"GalaxyViewPlus_Config"};static STORAGE_TYPE="localStorage";static UPDATE_INTERVAL=6;static UPDATE_INTERVAL_DELAY=2;static UPDATE_INTERVAL_STARTTIME=0;static USER_DEFINED_FEATURE_PROPERTIES=["active","data","sortData"]}class i{static#e="StorageInterface";static deleteStorageItem(t){try{return localStorage.removeItem(t),!0}catch(t){return i.log("Failed to delete a key from Storage",e.ERROR,t),!1}}static getStorageItem(t){try{return JSON.parse(localStorage.getItem(t)||"{}")}catch(t){return i.log("Failed to get a key from Storage",e.ERROR,t),!1}}static log(t,a=e.INFO,s=""){i.writeLog(t,a,i.#e,s)}static setStorageItem(t,a){try{return localStorage.setItem(t,JSON.stringify(a)),!0}catch(t){return i.log("Failed to save a key from Storage",e.ERROR,t),!1}}static writeLog(t,a=e.INFO,s="",c=""){const l=`[GalaxyViewPlus_${s} ${new Date(Date.now()).toISOString()}] [${a}]: ${t}`;a===e.ERROR&&(console.log(l),console.error(c));try{let e=n.defaultTo(i.getStorageItem(r.STORAGE_KEYS.DEBUG_LOG),[]);e.push(l),e.length>r.DEBUG_LOG_MAX_ENTRIES&&(e=e.slice(-r.DEBUG_LOG_MAX_ENTRIES)),i.setStorageItem(r.STORAGE_KEYS.DEBUG_LOG,e)}catch(e){console.error("Critical error in writeLog:",e)}}}class c{static escapeString(e){const t={'"':"&quot;","&":"&amp;","'":"&#x27;","/":"&#x2F;","<":"&lt;",">":"&gt;"};return e.replaceAll(/["&'/<>]/g,(e=>t[e]))}static getFilteredObject(e,t=[]){const a=c.getObjectDeepCopy(e);return c.#t(a,t)}static getObjectDeepCopy(e){return JSON.parse(JSON.stringify(e))}static getTimestamp(){return Date.now()}static getTimeStampString(){return(new Date).toISOString()}static isBoolean(e){return"boolean"==typeof e}static isInt(e,t=!1){if("string"==typeof e&&t){const t=Number.parseInt(e,10);return Number.isInteger(t)&&String(t)===e}return c.#a(e,Number.isInteger)}static isObjectEqual(e,t){return JSON.stringify(e)===JSON.stringify(t)}static isString(e){return c.#a(e,(e=>"string"==typeof e))}static migrateConfig(e,t){const a=c.getObjectDeepCopy(e),s=c.getObjectDeepCopy(t);return a.features.forEach((e=>{const t=s.features.find((t=>e.feature===t.feature));t&&(t.data=e.data??t.data,t.active=e.active??t.active)})),c.getObjectDeepCopy(s)}static sanitizeStrings(e){return Array.isArray(e)?e.map((e=>c.escapeString(e))):c.escapeString(e)}static uniqueItems(e){return Array.isArray(e)?[...new Set(e)]:e}static validateColorInput(e){return/^#[\dA-Fa-f]{6}$/.test(e)}static validateConfig(e,t=r.DEFAULT_CONFIG,a=r.USER_DEFINED_FEATURE_PROPERTIES){const s=c.getFilteredObject(e,a),n=c.getFilteredObject(t,a);return c.isObjectEqual(s,n)}static validateNumberInput(e){return/^\d*$/.test(e)}static validateStringInput(e){return/^[\p{L}\p{N}_\-. ]*$/u.test(e)}static#t(e,t){if(!e||void 0===e.features||!t)return e;const a=n.forceArray(t),s=c.getObjectDeepCopy(e),r=s.features.map((e=>(a.forEach((t=>{delete e[t]})),e)));return s.features=r,s}static#a(e,t){return Array.isArray(e)?e.every((e=>t(e))):t(e)}}class l{constructor(e,t){this.config=e,this.inputData=t}execute(){const e=Array.isArray(this.inputData)?this.inputData[0].id.split("-")[0]:this.inputData.id.split("-")[0],{data:t}=this.config.features.find((t=>t.htmlPrefix===e));Array.isArray(this.inputData)?l.updateKeyValueData(t,this.inputData[0],this.inputData[1]):l.updateValueData(t,this.inputData)}static updateKeyValueData(e,t,a){if(!e.some((e=>e.key===t.lastvalue&&e.value===a.lastvalue)))return void e.push({key:t.value,value:a.value});const s=e.find((e=>e.key===t.lastvalue&&e.value===a.lastvalue));s.key=t.value,s.value=a.value}static updateValueData(e,t){if(!n.isThisOrThat(t.type,"checkbox","radio")){e.find((e=>e.key===t.name)).value=t.value}if("checkbox"===t.type){e.find((e=>e.key===t.name)).checked=t.checked}"radio"===t.type&&e.forEach((e=>{e.checked=e.value===t.value}))}}class o{constructor(e,t){this.config=e,this.inputData=t}execute(){const e=this.inputData.id.split("-")[0],t=this.config.features.find((t=>t.htmlPrefix===e));t&&(t.sortData=this.inputData.checked)}}class u{constructor(e,t){this.config=e,this.inputData=t}execute(){const e=this.inputData.id.split("-")[0],t=this.config.features.find((t=>t.htmlPrefix===e));t&&(t.active=this.inputData.checked)}}class p{constructor(e,t){this.config=e,this.removeData=t}execute(){if(!Array.isArray(this.removeData)||2!==this.removeData.length)return;const e=this.removeData[0].id.split("-")[0],t=this.config.features.find((t=>t.htmlPrefix===e)),a=t.data.filter((e=>!(e.key===this.removeData[0].value&&e.value===this.removeData[1].value)));t.data=a}}class d{constructor(e){this.resetFunction=e}execute(){this.resetFunction()}}class h{constructor(e){this.saveFunction=e}execute(){this.saveFunction()}}class g{static#s;static#e="ConfigManager";#n;constructor(){if(g.#s)return g.#s;g.#s=this,this.#r(),this.#i()}actionCallback(t,a){Object.keys(this.commandMap).includes(t)&&void 0!==this.commandMap[t].class?this.#c(t,a):g.log(`Invalid Command ${t}`,e.ERROR)}getActionCallback(){return this.actionCallback.bind(this)}getCurrentConfig(){return this.#n}#c(t,a){const s=this.commandMap[t].class,n=new s(...[this.commandMap[t].systemInput,a]);try{n.execute()}catch(t){g.log(`Error executing command ${s.name}:`,e.ERROR,t)}}#i(){this.commandMap={changeData:{class:l,systemInput:this.#n},changeSorting:{class:o,systemInput:this.#n},changeStatus:{class:u,systemInput:this.#n},removeRow:{class:p,systemInput:this.#n},resetConfig:{class:d,systemInput:this.#l.bind(this)},saveConfig:{class:h,systemInput:this.#o.bind(this)}}}#r(){g.log("loading config from storage",e.DEBUG);const t=r.STORAGE_KEYS,a=i.getStorageItem(t.USER_CONFIG,"{}");return n.isEmptyObject(a)?(g.log("config is empty. loading default config.",e.WARN),this.#n=r.DEFAULT_CONFIG,void this.#u()):c.validateConfig(a)?(g.log("using valid config from storage",e.DEBUG),void(this.#n=a)):(g.log("config is invalid or needs an update. starting migration",e.WARN),this.#n=c.migrateConfig(a,r.DEFAULT_CONFIG),void this.#u())}#l(){g.log("Restoring default config",e.WARN),this.#n=r.DEFAULT_CONFIG,this.#u()}#u(){i.setStorageItem(r.STORAGE_KEYS.USER_CONFIG,this.#n),document.location.reload()}#o(){c.validateConfig(this.#n)?this.#u():alert("etzadla iwas stimmd mid deina Gonfig nedd häddix8 ghabd")}static _resetInstance(){g.#s=void 0}static log(t,a=e.INFO,s=""){i.writeLog(t,a,g.#e,s)}}class m{constructor(e="",t=[],a={}){this.id=e,this.classList=t,this.attributes=a,this.element=void 0}addClass(e){this.element.classList.add(e)}addEventListener(e,t){this.element.addEventListener(e,t)}after(e){this.#p(e,"after")}append(e){this.#p(e,"append")}getElement(){return this.element.id=this.id,n.isSomething(this.classList)&&this.#d(this.classList),n.isEmptyObject(this.attributes)||this.#h(),this.textContent&&this.setTextContent(this.textContent),this.element}setAttribute(e,t){this.element.setAttribute(e,t)}setTextContent(e){0===this.element.children.length&&(this.element.textContent=e)}#d(e){Array.isArray(e)&&e.forEach((e=>this.addClass(e))),"string"==typeof e&&""!==e.trim()&&e.trim().split(" ").forEach((e=>this.addClass(e)))}#p(e,t){e instanceof m?this.element[t](e.getElement()):e instanceof HTMLElement?this.element[t](e):console.error(`${t} expects an instance of Element`)}#h(){n.forAny(this.attributes,(([e,t])=>{this.element.setAttribute(e,t)}),!0)}}class y extends m{constructor(e,t={}){const{attributes:a={},classList:s=[],color:n="",forId:r="",id:i="",textContent:c="",title:l=""}=t;super(i,s,a),this.element=document.createElement(e),this.element.textContent=c,"label"===e&&(this.element.setAttribute("for",r),this.element.setAttribute("title",l)),"span"===e&&(this.element.style.color=n)}}class f{static create(e,t={}){return new y(e,t).getElement()}}class b{static execute(e){const t=Date.now()-e,a=b.#g(t),s=b.#m(a);document.querySelector("#settings-interface-details").append(s)}static#m(e){const t=f.create("div",{id:"debug-info"});return n.forAny(e,(([e,a])=>{t.append(f.create("p",{textContent:`${e}: ${a}`}))}),!0),t}static#g(e){const t=i.getStorageItem(r.STORAGE_KEYS.UPDATE_STATUS),a=i.getStorageItem(r.STORAGE_KEYS.STATS_DATA);return{currentConfigVersion:i.getStorageItem(r.STORAGE_KEYS.USER_CONFIG).configVersion,defaultConfigVersion:r.DEFAULT_CONFIG.configVersion,executionTime:`${e}ms`,scriptVersion:GM.info.script.version,statsDataCount:`${Object.keys(a).length} Players`,statsUpdateStatus:t.status,statsUpdateTimestamp:new Date(t.timestamp).toISOString()}}}class v{static execute(){const e=v.#y(),t=v.#f(e);document.querySelector("#settings-interface-details").lastChild.after(t)}static#f(e){const t=f.create("div",{id:"debug-log"});return e.forEach((e=>{t.append(f.create("p",{textContent:`${e}`}))})),t}static#y(){return i.getStorageItem(r.STORAGE_KEYS.DEBUG_LOG)}}class S{static execute(){document.querySelector("#settings-interface-details").open=!0}}class T{static execute(){document.addEventListener("keydown",(e=>{"e"===e.key&&(location.assign("javascript:syncsys()"),document.querySelector("#gala_sync").value="Synced")}))}}class k{static execute({features:e},t){const a=e.find((e=>"generalsettings"===e.feature));if(!a)return;const s={configOpen:{Class:S,params:void 0},debugInfo:{Class:b,params:t},debugLog:{Class:v,params:void 0},syncbutton:{Class:T,params:void 0}};a.data.forEach((e=>{e.checked&&s[e.key].Class.execute(s[e.key].params)}))}}class E{static inactiveSelector=".galaxy-short-inactive,.galaxy-short-longinactive";constructor([{value:e},{value:t}]){this.inactiveColor=e,this.longInactiveColor=t}execute(e){const t="A"===e.nextElementSibling?.tagName&&"I"===e.nextElementSibling.firstChild?.tagName?e.parentNode.querySelectorAll(E.inactiveSelector):e.querySelectorAll(E.inactiveSelector);t&&t.forEach((e=>{e.style.color=1===t?.length?this.inactiveColor:this.longInactiveColor,e.style.fontWeight="bold"}))}}class x{static coordsRegex=/(?<Gala>[1-4]):(?<Sys>\d{1,3}):(?<Pos>\d{1,2})(?<isMoon>] M)?/g;constructor([{value:e},{value:t},{value:a}],{currentSystem:s,currentGalaxy:n}){this.nearRange=Number.parseInt(e,10),this.minSys=Number.parseInt(t,10),this.maxSys=Number.parseInt(a,10),this.currentSystem=Number.parseInt(s,10),this.currentGalaxy=n}execute(e){const t=this.getTotalRange(),a=x.getCoordsFromToolTip(e.dataset.tooltipContent),s=x.getNearbyCounts(a,t,this.currentGalaxy),n=x.createNearElement(x.formatNearText(s));e.parentNode.append(n)}getCircularNumberRange(e,t){const a=this.maxSys-this.minSys+1;return Array.from({length:(t-e+a)%a},((t,s)=>(e+s-this.minSys)%a+this.minSys))}getTotalRange(){const e=x.getCircularPosition(this.currentSystem-this.nearRange,this.minSys,this.maxSys),t=x.getCircularPosition(this.currentSystem+this.nearRange,this.minSys,this.maxSys);return[...e<=this.currentSystem?this.getCircularNumberRange(e,this.currentSystem):[...this.getCircularNumberRange(e,this.maxSys+1),...this.getCircularNumberRange(this.minSys,this.currentSystem)],...t>=this.currentSystem?this.getCircularNumberRange(this.currentSystem,t+1):[...this.getCircularNumberRange(this.currentSystem,this.maxSys+1),...this.getCircularNumberRange(this.minSys,t+1)]]}static createNearElement(e){const t=f.create("span",{});return t.append(f.create("br",{})),t.append(f.create("span",{textContent:e})),t}static formatNearText(e){return`NearP: ${e.nearPlanets} NearM: ${e.nearMoons}`}static getCircularPosition(e,t,a){const s=a-t+1;return((e-t)%s+s)%s+t}static getCoordsFromToolTip(e){return e.matchAll(x.coordsRegex)}static getCurrentGalaxyAndSystem(){const[e,t]=document.evaluate("//table/tbody/tr/th[contains(text(), 'System ')]",document,null,XPathResult.STRING_TYPE,null).stringValue.split(" ")[1].split(":");return{currentGalaxy:e,currentSystem:t}}static getNearbyCounts(e,t,a){const s=[...e].map((([,e,t,,a])=>({gala:e,moon:a,sys:t})));let n=-1,r=0;return s.forEach((e=>{const s=Number.parseInt(e.sys,10);e.gala===a&&t.includes(s)&&(n++,e.moon&&r++)})),-1===n&&(n=0),{nearMoons:r,nearPlanets:n}}}class D{constructor(e=[],{params:t}={}){this.parseParameters(e,t),this.getRankTypeAndDisplayName()}execute(e){const t=e.childNodes[1].attributes.playerid.value,a=Number.parseInt(t,10);let s;try{s=this.statsInstance.getPlayerRank(a,this.rankType)}catch{s=D.userRankFallback(e),this.rankDisplayName="Gesamt"}const n=f.create("span",{}),r=`${this.rankDisplayName}: ${s}`;n.append(f.create("br",{})),n.append(f.create("span",{textContent:r}));const i=this.rankRecolorData.sort(((e,t)=>t.key-e.key)).find((e=>s>=e.key));i&&(n.style.color=i.value),e.parentNode.append(n)}getRankTypeAndDisplayName(){const{value:e="rank",displayName:t="Gesamt"}=this.rankTypeData.find((e=>!0===e.checked))||{};this.rankType=e,this.rankDisplayName=t}parseParameters(e,t){this.rankRecolorData=n.isType(e,[])?e:[],this.statsInstance=n.defaultTo(t?.stats,{}),this.rankTypeData=n.forceArray(n.defaultTo(t?.rank,[]))}static getParams(e,t){return{params:{rank:D.getRankSelectorData(e),stats:t}}}static getRankSelectorData(e){if(!e)return;const t=n.findAny(e,(e=>"rankSelector"===e.feature));return t&&Object.keys(t).includes("data")&&Array.isArray(t.data)?t.data:void 0}static userRankFallback(e){return e.dataset.tooltipContent.split("</th")[0].split(" ").pop()}}class C{constructor(e){this.userRecolorData=e}execute(e){if(0===e.children.length)return;const t=e.children[0],a=t.textContent.trim(),s=this.userRecolorData.find((e=>e.key===a));s&&(t.style.color=s.value)}}class R{static selector="a.tooltip_sticky > span.galaxy-username";static#e="IteratorModule";constructor({features:t},a){R.log("Starting feature iterator ",e.DEBUG),this.featureMap={inactiveRecolor:{Class:E,params:void 0},rangeInfo:{Class:x,params:x.getCurrentGalaxyAndSystem()},rankRecolor:{Class:D,params:D.getParams(t,a)},userRecolor:{Class:C,params:void 0}},this.invokeFeatures(t),R.log("Finished running feature iterator",e.DEBUG)}invokeFeatures(e){const t=n.mapAny([...document.querySelectorAll(R.selector)],(e=>e.parentNode));e.filter((e=>this.featureMap[e.feature]&&e.active)).map((e=>new this.featureMap[e.feature].Class(e.data,this.featureMap[e.feature].params))).forEach((e=>t.forEach((t=>e.execute(t)))))}static log(t,a=e.INFO,s=""){i.writeLog(t,a,R.#e,s)}}class I{static HTTP_METHOD="GET";static HTTP_REQUEST_TIMEOUT=5e3;static STATS_URL="https://pr0game.com/stats_Universe_2.json";static async fetchStatsJson(){return new Promise(((e,t)=>{GM.xmlHttpRequest({method:I.HTTP_METHOD,onerror:t,onload:e,timeout:I.HTTP_REQUEST_TIMEOUT,url:I.STATS_URL})}))}}class A{static STATUS_FINISHED="finished";static STATUS_IN_PROGRESS="inProgress";static#s;static#e="StatisticsInterface";statsAvailable=!1;statsData;constructor(){if(A.#s)return A.#s;A.#s=this}getPlayerIDByName(e){return Object.keys(this.statsData).find((t=>this.statsData[t].playerName===e))}getPlayerNameById(e){return this.statsData[e].playerName}getPlayerRank(e,t="rank"){return this.statsData[e][t]}getPlayerRankData(e){return this.statsData[e]}async initialize(){await this.#b()}async#b(){const t=i.getStorageItem(r.STORAGE_KEYS.UPDATE_STATUS),a=i.getStorageItem(r.STORAGE_KEYS.STATS_DATA);n.isEmptyObject(a)||n.isEmptyObject(t)||!A.#v(t)?(A.log("StatsData will be refreshed",e.DEBUG),await this.#S()):(this.statsData=a,this.statsAvailable=!0,A.log("StatsData successfully loaded from storage",e.DEBUG))}#T(t){const a={status:A.STATUS_IN_PROGRESS,timestamp:c.getTimestamp()};i.setStorageItem(r.STORAGE_KEYS.UPDATE_STATUS,a),A.log("Parsing StatsData",e.DEBUG);const s={};t.forEach((({playerId:e,playerName:t,allianceId:a,allianceName:n,rank:r,researchRank:i,buildingRank:c,fleetRank:l,defensiveRank:o})=>{s[e]={allianceId:a,allianceName:n,buildingRank:c,defensiveRank:o,fleetRank:l,playerName:t,rank:r,researchRank:i}})),i.setStorageItem(r.STORAGE_KEYS.STATS_DATA,s),this.statsData=s,this.statsAvailable=!0,a.status=A.STATUS_FINISHED,a.timestamp=c.getTimestamp(),i.setStorageItem(r.STORAGE_KEYS.UPDATE_STATUS,a),A.log("StatsData was parsed and written to storage",e.DEBUG)}async#S(){try{const e=await I.fetchStatsJson();200===e.status?this.#k(e):this.#E(e)}catch(e){this.#E(e)}}#E(t){A.log("Error while downloading StatsData:",e.WARN),A.log("Response was:",e.WARN,t);const a=i.getStorageItem(r.STORAGE_KEYS.STATS_DATA)||{};0!==Object.keys(a).length?(A.log("Old StatsData found in storage",e.DEBUG),this.statsData=a,this.statsAvailable=!0):A.log("No old StatsData found in storage",e.DEBUG)}#k(t){A.log("StatsData was successfully downloaded",e.DEBUG);const a=JSON.parse(t.responseText);A.log("Starting StatsData parsing",e.DEBUG),this.#T(a)}static _resetInstance(){A.#s=void 0}static log(t,a=e.INFO,s=""){i.writeLog(t,a,A.#e,s)}static#v(e){const t=(new Date).getHours(),a=t-t%r.UPDATE_INTERVAL,s=new Date;return s.setHours(a,r.UPDATE_INTERVAL_DELAY,0,0),e.status===A.STATUS_FINISHED&&e.timestamp>s}}class N extends m{constructor(e={}){const{attributes:t={},classList:a=[],eventListeners:s={},id:r="",textContent:i=""}=e;super(r,a,t),this.element=document.createElement("button"),this.element.textContent=i,n.forAny(s,(e=>{n.hasThisAndThatProp(e,"eventType","callback")&&this.addEventListener(e.eventType,e.callback)}))}}class O{static create(e,t={}){const a={addRow:{classList:["add-row-btn"],textContent:"Hinzufügen"},button:{},removeRow:{classList:["remove-row-btn"],textContent:"Löschen"},reset:{classList:["reset-config-btn"],textContent:"Zurücksetzen"},save:{classList:["save-config-btn"],textContent:"Speichern"}}[e];if(a){const e={...a,...t};return new N(e).getElement()}console.error(`Button type '${e}' is not supported.`)}}class w{constructor(e){this.eventType=e,this.wrapperObject=void 0}getWrapper(){return this.wrapperObject}static extractInputData({checked:e,className:t,dataset:a={},id:s,name:n,type:r,value:i}){const{lastvalue:c}=a,l="number"===r?Number.parseInt(i,10):i;return{checked:e,className:t,id:s,lastvalue:"number"===r?Number.parseInt(c,10):c,name:n,type:r,value:l}}static extractInputPairData(e){const t=w.extractParentRowFromCellEvent(e);return w.extractInputPairFromRow(t).map((e=>w.extractInputData(e)))}static extractInputPairFromRow({children:[{firstChild:e},{firstChild:t}]}){return[e,t]}static extractParentRowFromCellEvent({target:{parentElement:{parentElement:e}}}){return e}static refreshLastValue({target:e}){e?.dataset&&(e.dataset.lastvalue=n.isThisOrThat(e.type,"checkbox","radio")?e.checked:e.value)}}const L={ActiveCheckBoxWrapper:{class:class extends w{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{callback:t=>{const a=w.extractInputData(t.target);e("changeStatus",a),w.refreshLastValue(t);const{target:{parentElement:{nextSibling:s}=t}}=t;s&&s.classList&&(!0===a.checked?s.classList.remove("hidden"):s.classList.add("hidden"))},eventType:this.eventType}}},event:"click"},AddRowButtonWrapper:{class:class extends w{constructor(e,{addRow:t,delButton:a}){super(e),this.wrapperObject=this.buildWrapperObject(t,a)}buildWrapperObject(e,t){return{callback:a=>{const{target:{parentElement:{children:[,s]}}}=a;e(s,t)},eventType:this.eventType}}},event:"click"},InputPairWrapper:{class:class extends w{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{callback:t=>{const a=w.extractInputPairData(t);e("changeData",a),w.refreshLastValue(t)},eventType:this.eventType}}},event:"change"},InputWrapper:{class:class extends w{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{callback:t=>{const a=w.extractInputData(t.target);e("changeData",a),w.refreshLastValue(t)},eventType:this.eventType}}},event:"change"},RemoveRowButtonWrapper:{class:class extends w{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{callback:t=>{const a=w.extractParentRowFromCellEvent(t),s=w.extractInputPairData(t);e("removeRow",s),a.remove()},eventType:this.eventType}}},event:"click"},ResetConfigWrapper:{class:class extends w{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{callback:t=>{const a=w.extractInputData(t.target);e("resetConfig",a)},eventType:this.eventType}}},event:"click"},SaveConfigWrapper:{class:class extends w{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{callback:t=>{const a=w.extractInputData(t.target);e("saveConfig",a)},eventType:this.eventType}}},event:"click"},SortCheckboxWrapper:{class:class extends w{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{callback:t=>{const a=w.extractInputData(t.target);e("changeSorting",a),w.refreshLastValue(t)},eventType:this.eventType}}},event:"click"}};class _{static create(e,t){const a=L[e];if(a){const{class:e,event:s}=a;return new e(s,t).getWrapper()}console.error(`Wrapper type '${e}' is not supported.`)}}class P extends m{constructor(e="text",t={}){const{attributes:a={},checked:s=!1,classList:r=[],eventListeners:i={},id:c="",name:l="",value:o=""}=t;super(c,r,a,i),this.element=document.createElement("input"),this.element.type=e,this.element.name=l,this.element.value=o,"checkbox"!==e&&"radio"!==e||(this.element.checked=s),n.forAny(i,(e=>{n.hasThisAndThatProp(e,"eventType","callback")&&this.addEventListener(e.eventType,e.callback)}))}}class G{static create(e,t={},a=!1){const s=new P(e,t);return a&&s.addEventListener("keydown",(e=>{e.stopPropagation(),e.stopImmediatePropagation()})),s.getElement()}}class U extends m{constructor(e,t={}){const{id:a="",classList:s=[],attributes:r={},children:i=[],textContent:c=""}=t;super(a,s,r),this.element=document.createElement(e),this.textContent=c,n.forAny(i,(e=>this.append(e)))}}class F{static create(e,t={}){if(!["table","thead","tbody","tr","th","td","tfoot"].includes(e))return void console.error(`TableElement type '${e}' is not supported.`);return new U(e,t).getElement()}}class ${constructor(e,t){this.prefix=`${e.htmlPrefix}`,this.element=F.create("table",{classList:[`${this.prefix}`,`${e.dataType}`],id:`${this.prefix}-tablecontainer`,children:this.#x(e,e.dataType,t)})}getElement(){return this.element}#D(e,t){return[F.create("td",{children:f.create("label",{classList:`${this.prefix}-${e.key}-label`,forId:`${this.prefix}-input-${e.key}`,textContent:e.displayName,title:e.valueDescription})}),F.create("td",{children:[G.create(e.inputType,{attributes:{"data-lastvalue":e.value},checked:e.checked,classList:`${this.prefix}-${e.key}-input`,eventListeners:_.create("InputWrapper",t),id:`${this.prefix}-input-${e.key}`,name:`${e.key}`,value:e.value},!0)]})]}#x(e,t,a){return e.data.map((e=>F.create("tr",{classList:`${t} ${t}-row`,id:`${this.prefix}-row`,children:this.#D(e,a)})))}}class j{constructor(e,t){this.prefix=`${e.htmlPrefix}`,this.keyInputType=e.keyInputType,this.valueInputType=e.valueInputType,this.keyDefault=e.keyDefault,this.valueDefault=e.valueDefault,this.element=F.create("table",{classList:[`${this.prefix}`,`${e.dataType}`],id:`${this.prefix}-tablecontainer`,children:[this.buildTableHeader("valuetable-header",[e.keyDisplayName,e.valueDisplayName,"Löschen"]),this.buildTableBody(e,t),j.buildAddRowButton(this.addDefaultTableRow.bind(this),t)]})}addDefaultTableRow(e,t){e.append(j.buildTableRow(this.prefix,this.keyInputType,this.valueInputType,this.keyDefault,this.valueDefault,t))}buildTableBody(e,t){return F.create("tbody",{classList:"valuetable-body",id:`${this.prefix}-tablebody`,children:e.data.map((a=>j.buildTableRow(this.prefix,e.keyInputType,e.valueInputType,a.key,a.value,t)))})}buildTableHeader(e,t=["","",""],a=["key","value","delete"]){return F.create("thead",{classList:"valuetable-header",id:`${this.prefix}-tableheader`,children:F.create("tr",{classList:`${e} ${e}-row`,id:`${this.prefix}row`,children:[0,1,2].map((e=>F.create("th",{id:`${this.prefix}cell-${a[e]}`,textContent:t[e]})))})})}getElement(){return this.element}static buildAddRowButton(e,t){const a={addRow:e,delButton:t};return O.create("addRow",{eventListeners:_.create("AddRowButtonWrapper",a)})}static buildInputCell(e,t,a,s,n){return F.create("td",{children:[j.buildInputElement(t,{classList:`${e}-${a}`,id:`${e}-${a}-${s}`,name:`${a}input`,value:s},n)]})}static buildInputElement(e,{name:t,value:a,id:s,classList:n},r){return G.create(e,{attributes:{"data-lastvalue":a},classList:n,eventListeners:_.create("InputPairWrapper",r),id:s,name:t,value:a},!0)}static buildRemoveRowButton(e){return O.create("removeRow",{eventListeners:_.create("RemoveRowButtonWrapper",e)})}static buildTableRow(e,t,a,s,n,r){return F.create("tr",{children:j.buildTableRowCells(e,t,a,s,n,r)})}static buildTableRowCells(e,t,a,s,n,r){return[j.buildInputCell(e,t,"key",s,r),j.buildInputCell(e,a,"value",n,r),F.create("td",{children:[j.buildRemoveRowButton(r)]})]}}class W{static create(e,t){switch(e.dataType){case"ValueTable":return new j(e,t).getElement();case"ValueList":return new $(e,t).getElement();default:console.error(`DataType '${e.dataType}' is not supported.`)}}}class V{constructor(e,t){this.prefix=`${e.htmlPrefix}`,this.baseClass="feature-body",this.element=f.create("div",{classList:`${this.baseClass}-container`,id:`${this.prefix}-body-container`}),e.active||this.element.classList.add("hidden"),this.element.append(W.create(e,t))}getElement(){return this.element}}class B{constructor(e,t){this.prefix=`${e.htmlPrefix}-header-`,this.baseClass="feature-header",this.element=f.create("div",{classList:[`${this.baseClass}-container`],id:`${this.prefix}container`}),this.element.append(f.create("p",{attributes:{title:e.description},classList:`${this.baseClass}-title`,id:`${this.prefix}title`,textContent:e.displayName})),this.element.append(f.create("br",{})),this.element.append(f.create("label",{forId:`${this.prefix}-status-checkbox`,textContent:"Aktiv:"})),this.element.append(G.create("checkbox",{attributes:{"data-lastvalue":e.active},checked:e.active,classList:[`${this.baseClass}-statusCheckbox`],eventListeners:_.create("ActiveCheckBoxWrapper",t),id:`${this.prefix}status-checkbox`,name:`${this.prefix}status-checkbox`})),e.sortData&&(this.element.append(f.create("label",{forId:`${this.prefix}sort-checkbox`,textContent:"Sortieren:"})),this.element.append(G.create("checkbox",{attributes:{"data-lastvalue":e.active},checked:e.sortData,classList:[`${this.baseClass}-sortCheckbox`],eventListeners:_.create("SortCheckboxWrapper",t),id:`${this.prefix}sort-checkbox`,name:`${this.prefix}sort-checkbox`})))}getElement(){return this.element}}class M{static create(e,t){const a=f.create("div",{classList:"feature-settings-container",id:`${e.htmlPrefix}settings-container`}),s=new B(e,t),n=new V(e,t);return a.append(s.getElement()),a.append(n.getElement()),a}}class K{constructor(e){const t=e.getCurrentConfig(),a=e.getActionCallback(),{features:s,userInterface:{title:n}}=t;this.element=f.create("div",{id:"settings-interface-wrapper"});const r=f.create("details",{id:"settings-interface-details"}),i=f.create("summary",{id:"settings-interface-summary"});i.textContent=n;const c=s.map((e=>M.create(e,a)));r.append(i),c.map((e=>r.append(e)));const l=f.create("div",{id:"settings-interface-footer"}),o=O.create("save",{classList:"settings-save-button",eventListeners:_.create("SaveConfigWrapper",a),id:"save-button",textContent:"Speichern"}),u=O.create("reset",{classList:"settings-reset-button",eventListeners:_.create("ResetConfigWrapper",a),id:"reset-button",textContent:"Zurücksetzen"});l.append(o),l.append(u),r.append(l),this.element.append(r)}getElement(){return this.element}}class Y{constructor(e){this.SettingsInterface=new K(e).getElement(),this.galaxyTable=document.querySelector(".table569"),this.SettingsInterface=Y.#C(this.SettingsInterface,this.galaxyTable),Y.#R(e.getCurrentConfig().userInterface.css),this.galaxyTable.after(this.SettingsInterface)}static#R(e){GM.addStyle(e)}static#C(e,t){const a=window.getComputedStyle(t),s=e;return s.style.margin=a.margin,s.style.alignSelf=a.alignSelf,s.style.width=a.width,s}}class z{static async run(){const t=Date.now();i.writeLog("Starting script",e.INFO,"Main");const a=new g,s=new A;await s.initialize();new Y(a),new R(a.getCurrentConfig(),s);k.execute(a.getCurrentConfig(),t),i.writeLog("Finished script",e.INFO,"Main")}}"undefined"!=typeof process&&void 0!==process.env.JEST_WORKER_ID||z.run()})();