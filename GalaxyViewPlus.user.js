// ==UserScript==
// @name        GalaxyViewPlus
// @description I hab scho mit 3 im Wald mid mein Vadder usernamne gefärbdne und Ränggne gschriebne
// @version     1.1.3
// @author      Architekt Apx aka. Dr. Architekt1510, Altschauerberg 8, 91448 Emskirchen
// @homepage    https://github.com/ArchitektApx/GalaxyViewPlus
// @match       https://pr0game.com/*/game.php?*page=galaxy*
// @connect     pr0game.com
// @downloadURL https://raw.githubusercontent.com/ArchitektApx/GalaxyViewPlus/master/GalaxyViewPlus.user.js
// @grant       GM_addStyle
// @grant       GM.xmlHttpRequest
// @updateURL   https://raw.githubusercontent.com/ArchitektApx/GalaxyViewPlus/master/GalaxyViewPlus.user.js
// ==/UserScript==

(()=>{"use strict";class e{static CLEANUP_INTERVAL=168;static DEBUG_LOG_MAX_ENTRIES=20;static DEFAULT_CONFIG={configVersion:"1.0.5",features:[{feature:"userRecolor",displayName:"Usernamen Färben",description:"Färbt den Usernamen des Users ein.",active:!0,htmlPrefix:"userRecolor",dataType:"ValueTable",keyName:"Username",keyDescription:"Der Username des Users",keyDisplayName:"Username",keyInputType:"text",keyDefault:"BeispielUserName",valueName:"Farbe",valueDescription:"Die Farbe welche für den Usernamen verwendet wird",valueDisplayName:"Farbe",valueInputType:"color",valueDefault:"#ffa700",data:[{key:"BeispielUserName",value:"#ffa700"}],sortData:!0},{feature:"rankRecolor",displayName:"Rank Färben",description:"Färbt den Rank des Users ein.",active:!0,htmlPrefix:"rankRecolor",dataType:"ValueTable",keyName:"Rank",keyDescription:"Der Rang ab welchem die Farbe angewant wird",keyDisplayName:"Rank",keyInputType:"number",keyDefault:0,valueName:"Farbe",valueDescription:"Die Farbe welche für den Rang verwendet wird",valueDisplayName:"Farbe",valueInputType:"color",valueDefault:"#2cba00",data:[{key:0,value:"#2cba00"},{key:200,value:"#a3ff00"},{key:500,value:"#fff400"},{key:600,value:"#ffa700"},{key:700,value:"#ff0000"}],sortData:!0},{feature:"inactiveRecolor",displayName:"Inaktive Färben",description:"Färbt inaktive User ein.",active:!1,htmlPrefix:"inactiveRecolor",dataType:"ValueList",data:[{key:"inactiveColor",valueDescription:"Inaktiv (i)",displayName:"Inaktiv (i)",inputType:"color",value:"#f70fff"},{key:"longInactiveColor",valueDescription:"Lange Inaktiv (i l)",displayName:"Lange i (i l)",inputType:"color",value:"#ff00ff"}]},{feature:"rangeInfo",displayName:"RangeInfo",description:"Zeigt die Anzahl der Planeten/Monde im Umkreis des aktuellen Systems an. Achtung: funktioniert nur wenn Planeten/Mond Infos durch Syncs/Json/CSV vorhanden sind!",active:!0,htmlPrefix:"rangeInfo",dataType:"ValueList",data:[{key:"nearRange",valueDescription:"Anzahl der System vor/nach dem aktuellen welche überprüft werden.",displayName:"Radius",inputType:"number",value:20},{key:"minSys",valueDescription:"Das erste System in der Galaxy. Mach etzadla kein Unfug häddix8 ghabt!",displayName:"Min. Sys.",inputType:"number",value:1},{key:"maxSys",valueDescription:"Das letzte System in der Galaxy. Mach etzadla kein Unfug häddix8 ghabt!",displayName:"Max. Sys.",inputType:"number",value:400}]},{feature:"rankSelector",displayName:"Rangtyp (für Rank färben) wählen",description:"Verändert den Rang welcher im Galaxy View angezeigt wird",active:!1,htmlPrefix:"rankSelector",dataType:"ValueList",data:[{key:"rankSelect",valueDescription:"rankSelect",displayName:"Gesamt",inputType:"radio",value:"rank",checked:!0},{key:"rankSelect",valueDescription:"rankSelect",displayName:"Gebäude",inputType:"radio",value:"buildingRank",checked:!1},{key:"rankSelect",valueDescription:"rankSelect",displayName:"Forschung",inputType:"radio",value:"researchRank",checked:!1},{key:"rankSelect",valueDescription:"rankSelect",displayName:"Flotte",inputType:"radio",value:"fleetRank",checked:!1},{key:"rankSelect",valueDescription:"rankSelect",displayName:"Verteidigung",inputType:"radio",value:"defensiveRank",checked:!1}]},{feature:"generalsettings",displayName:"Generelle Einstellungen",description:"Einstellungen die sich nicht auf Spieler sondern das Skript ansich beziehen.",active:!0,htmlPrefix:"generalsettings",dataType:"ValueList",data:[{key:"syncbutton",valueDescription:"Shortcut der den Sync Button auf die e-Taste legt",displayName:"Sync shortcut auf E",inputType:"checkbox",value:"syncbutton",checked:!0},{key:"debugInfo",valueDescription:"Zeigt Informationen über das Script an",displayName:"Debug Infos anzeigen",inputType:"checkbox",value:"debugInfo",checked:!0},{key:"debugLog",valueDescription:"Zeigt Log Informationen der Module an",displayName:"Debug Log anzeigen",inputType:"checkbox",value:"debugLog",checked:!0},{key:"configOpen",valueDescription:"Öffnet die Config beim Start",displayName:"Config offen halten",inputType:"checkbox",value:"configOpen",checked:!1}]}],userInterface:{title:"Galaxy View Plus Config",css:'\n                .settings-interface-wrapper {\n                    margin-top: 10px;\n                    margin-bottom: 10px;\n                    width: 100%;\n                }\n\n                .feature-settings-container {\n                    width: calc(50% - 20px);\n                    margin-left: 10px;\n                    margin-right: 10px;\n                    display: inline-block;\n                    vertical-align: top;\n                }\n\n                .feature-header-title {\n                  font-weight: bold;\n                }\n\n                .feature-header-container {\n                  margin-bottom: 10px;\n                }\n\n                .feature-header-container label,\n                .feature-header-container input[type="checkbox"] {\n                  display: inline-block;\n                  vertical-align: top; /* Align label and checkbox at the top of their line */\n                }\n\n                .feature-header-container label:nth-of-type(1)\n                .feature-header-container input[type="checkbox"]:nth-of-type(1) {\n                  float: left;\n                }\n\n                .feature-header-container label:nth-of-type(2){\n                  clear: left;\n                  margin-left: 5%;\n                }\n\n                .feature-header-container p,\n                .feature-header-container label {\n                  text-align: left;\n                }\n\n                .feature-header-container label {\n                    width: 20%;\n                }\n\n                .feature-body-container {\n                    width: 80%;\n                }\n\n                .feature-body-container table {\n                    width: 100%;\n                }\n\n                .feature-body-container button {\n                    margin-top: 10px;\n                }\n\n                .ValueList-row {\n                    margin-bottom: 10px;\n                }\n\n                .ValueList-row label {\n                    display: inline-block;\n                }\n\n                .hidden {\n                    display: none;\n                }\n\n                #settings-interface-footer {\n                    margin-top: 20px;\n                    width: 100%;\n                    text-align: center;\n                } \n                '}};static HTTP_MAX_RETRY_COUNT=3;static HTTP_METHOD="GET";static HTTP_REQUEST_TIMEOUT=1e3;static HTTP_USER_AGENT="GalaxyViewPlus - bei Problemen -> architekt am Discord";static STATS_URL="https://pr0game.com/stats_Universe_2.json";static STORAGE_KEYS={USER_CONFIG:"GalaxyViewPlus_Config",CLEANUP_STATUS:"GalaxyViewPlus_CleanupStatus",UPDATE_STATUS:"GalaxyViewPlus_UpdateStatus",STATS_DATA:"GalaxyViewPlus_StatsData",DEBUG_LOG:"GalaxyViewPlus_DebugLog"};static STORAGE_TYPE="localStorage";static UPDATE_INTERVAL=6;static UPDATE_INTERVAL_DELAY=2;static UPDATE_INTERVAL_STARTTIME=0;static USER_DEFINED_FEATURE_PROPERTIES=["active","data","sortData"]}class t{static#e="StorageInterface";static deleteStorageItem(e){try{return localStorage.removeItem(e),!0}catch(e){return t.#t("Failed to delete a key from Storage","error",e),!1}}static getStorageItem(e){try{return JSON.parse(localStorage.getItem(e)||"{}")}catch(e){return t.#t("Failed to get a key from Storage","error",e),!1}}static setStorageItem(e,a){try{return localStorage.setItem(e,JSON.stringify(a)),!0}catch(e){return t.#t("Failed to save a key from Storage","error",e),!1}}static writeLog(a,n="log",s="",r=""){const i=new Date(Date.now()).toISOString(),c=`[GalaxyViewPlus_${s} ${i}] [${n}]: ${a}`;try{let l=t.getStorageItem(e.STORAGE_KEYS.DEBUG_LOG);!1===Array.isArray(l)&&(l=[]),l.push(c),l.length>e.DEBUG_LOG_MAX_ENTRIES&&l.shift(),t.setStorageItem(e.STORAGE_KEYS.DEBUG_LOG,l),"error"===n&&(console.log(`[GalaxyViewPlus${s} ${i}] [${n}]: ${a}`),console.error(r))}catch(e){console.error("Critical error in writeLog:",e)}}static#t(e,a,n){t.writeLog(e,a,t.#e,n)}}class a{static escapeString(e){const t={'"':"&quot;","&":"&amp;","'":"&#x27;","/":"&#x2F;","<":"&lt;",">":"&gt;"};return e.replaceAll(/["&'/<>]/g,(e=>t[e]))}static getFilteredObject(e,t=[]){const n=a.getObjectDeepCopy(e);return a.#a(n,t)}static getObjectDeepCopy(e){return JSON.parse(JSON.stringify(e))}static getTimestamp(){return Date.now()}static getTimeStampString(){return(new Date).toISOString()}static isBoolean(e){return"boolean"==typeof e}static isInt(e,t=!1){if("string"==typeof e&&t){const t=Number.parseInt(e,10);return Number.isInteger(t)&&String(t)===e}return a.#n(e,Number.isInteger)}static isObjectEqual(e,t){return JSON.stringify(e)===JSON.stringify(t)}static isString(e){return a.#n(e,(e=>"string"==typeof e))}static migrateConfig(e,t){const n=a.getObjectDeepCopy(e),s=a.getObjectDeepCopy(t);return n.features.forEach((e=>{const t=s.features.find((t=>e.feature===t.feature));t&&(t.data=e.data??t.data,t.active=e.active??t.active)})),a.getObjectDeepCopy(s)}static sanitizeStrings(e){return Array.isArray(e)?e.map((e=>a.escapeString(e))):a.escapeString(e)}static uniqueItems(e){return Array.isArray(e)?[...new Set(e)]:e}static validateColorInput(e){return/^#[\dA-Fa-f]{6}$/.test(e)}static validateConfig(e,t,n=[]){const s=a.getFilteredObject(e,n),r=a.getFilteredObject(t,n);return a.isObjectEqual(s,r)}static validateNumberInput(e){return/^\d*$/.test(e)}static validateStringInput(e){return/^[\p{L}\p{N}_\-. ]*$/u.test(e)}static#a(e,t){if(!e||void 0===e.features||!t)return e;const n=Array.isArray(t)?t:[t],s=a.getObjectDeepCopy(e),r=s.features.map((e=>(n.forEach((t=>{delete e[t]})),e)));return s.features=r,s}static#n(e,t){return Array.isArray(e)?e.every((e=>t(e))):t(e)}}class n{constructor(e,t){this.config=e,this.inputData=t}execute(){const e=Array.isArray(this.inputData)?this.inputData[0].id.split("-")[0]:this.inputData.id.split("-")[0],{data:t}=this.config.features.find((t=>t.htmlPrefix===e));Array.isArray(this.inputData)?n.updateKeyValueData(t,this.inputData[0],this.inputData[1]):n.updateValueData(t,this.inputData)}static updateKeyValueData(e,t,a){if(!e.some((e=>e.key===t.lastvalue&&e.value===a.lastvalue)))return void e.push({key:t.value,value:a.value});const n=e.find((e=>e.key===t.lastvalue&&e.value===a.lastvalue));n.key=t.value,n.value=a.value}static updateValueData(e,t){if("checkbox"!==t.type&&"radio"!==t.type){e.find((e=>e.key===t.name)).value=t.value}if("checkbox"===t.type){e.find((e=>e.key===t.name)).checked=t.checked}"radio"===t.type&&e.forEach((e=>{e.checked=e.value===t.value}))}}class s{constructor(e,t){this.config=e,this.inputData=t}execute(){const e=this.inputData.id.split("-")[0],t=this.config.features.find((t=>t.htmlPrefix===e));t&&(t.sortData=this.inputData.checked)}}class r{constructor(e,t){this.config=e,this.inputData=t}execute(){const e=this.inputData.id.split("-")[0],t=this.config.features.find((t=>t.htmlPrefix===e));t&&(t.active=this.inputData.checked)}}class i{constructor(e,t){this.config=e,this.removeData=t}execute(){if(!Array.isArray(this.removeData)||2!==this.removeData.length)return;const e=this.removeData[0].id.split("-")[0],t=this.config.features.find((t=>t.htmlPrefix===e)),a=t.data.filter((e=>!(e.key===this.removeData[0].value&&e.value===this.removeData[1].value)));t.data=a}}class c{constructor(e){this.resetFunction=e}execute(){this.resetFunction()}}class l{constructor(e){this.saveFunction=e}execute(){this.saveFunction()}}class o{static#s;static#e="ConfigManager";#r;constructor(){if(o.#s)return o.#s;o.#s=this,this.#i(),this.commandMap={changeData:{class:n,systemInput:this.#r},changeSorting:{class:s,systemInput:this.#r},changeStatus:{class:r,systemInput:this.#r},removeRow:{class:i,systemInput:this.#r},resetConfig:{class:c,systemInput:this.#c.bind(this)},saveConfig:{class:l,systemInput:this.#l.bind(this)}}}actionCallback(e,t){if(!Object.keys(this.commandMap).includes(e)||void 0===this.commandMap[e].class)return void o.#t(`Invalid Config Manager Command ${e}`,"error");const a=this.commandMap[e].class;o.#o(a,this.commandMap[e].systemInput,t)}getActionCallback(){return this.actionCallback.bind(this)}getCurrentConfig(){return this.#r}#i(){try{const n=e.STORAGE_KEYS,s=t.getStorageItem(n.USER_CONFIG,"{}");o.#t("loaded config from storage","debug"),0===Object.keys(s).length&&s.constructor===Object?(this.#r=e.DEFAULT_CONFIG,o.#t("config does not exist. loading default config.","warn"),this.#u()):a.validateConfig(s,e.DEFAULT_CONFIG,e.USER_DEFINED_FEATURE_PROPERTIES)?this.#r=s:(o.#t("config is empty, deprecated or invalid. starting repair","warn"),this.#r=a.migrateConfig(s,e.DEFAULT_CONFIG),o.#t("migration/repair finished successfully. saving new config","debug"),this.#u())}catch(t){o.#t("Error loading configuration:","error",t),o.#t("Loading default configuration","warn"),o.#t("if this keeps happening restore to overwrite the broken config.","warn"),this.#r=e.DEFAULT_CONFIG}}#c(){o.#t("Restoring default config","debug"),this.#r=e.DEFAULT_CONFIG,this.#u(),document.location.reload()}#u(){t.setStorageItem(e.STORAGE_KEYS.USER_CONFIG,this.#r)}#l(){a.validateConfig(this.#r,e.DEFAULT_CONFIG,e.USER_DEFINED_FEATURE_PROPERTIES)?(this.#u(),document.location.reload()):alert("etzadla iwas stimmd mid deina Gonfig nedd häddix8 ghabd")}static _resetInstance(){o.#s=void 0}static#o(e,...t){try{new e(...t).execute()}catch(t){o.#t(`Error executing command ${e.name}:`,"error",t)}}static#t(e,a,n=""){"error"===a&&""!==n?t.writeLog(e,a,o.#e,n):t.writeLog(e,a,o.#e)}}class u{constructor(e="",t=[],a={}){this.id=e,this.classList=t,this.attributes=a,this.element=void 0}addClass(e){this.element.classList.add(e)}addEventListener(e,t){this.element.addEventListener(e,t)}after(e){e instanceof u||e instanceof HTMLElement?(e instanceof u&&this.element.after(e.getElement()),e instanceof HTMLElement&&this.element.after(e)):console.error("append expects an instance of Element")}append(e){e instanceof u||e instanceof HTMLElement?(e instanceof u&&this.element.append(e.getElement()),e instanceof HTMLElement&&this.element.append(e)):console.error("append expects an instance of Element")}getElement(){return""!==this.id&&(this.element.id=this.id),this.classList.length>0&&this.#d(this.classList),Object.keys(this.attributes).length>0&&this.#p(),this?.textContent&&this.setTextContent(this.textContent),this.element}setAttribute(e,t){this.element.setAttribute(e,t)}setTextContent(e){0===this.element.children.length&&(this.element.textContent=e)}#d(e){Array.isArray(e)&&e.forEach((e=>this.addClass(e))),"string"==typeof e&&""!==e.trim()&&e.trim().split(" ").forEach((e=>this.addClass(e)))}#p(){Object.entries(this.attributes).forEach((([e,t])=>{this.element.setAttribute(e,t)}))}}class d extends u{constructor(e,t={}){const{attributes:a={},classList:n=[],color:s="",forId:r="",id:i="",textContent:c="",title:l=""}=t;super(i,n,a),this.element=document.createElement(e),this.element.textContent=c,"label"===e&&r&&this.element.setAttribute("for",r),"label"===e&&l&&this.element.setAttribute("title",l),"span"===e&&(this.element.style.color=s)}}class p{static create(e,t={}){return new d(e,t).getElement()}}class h{static execute(e){const t=Date.now()-e,a=h.#h(t),n=h.#g(a);document.querySelector("#settings-interface-details").append(n)}static#g(e){const t=p.create("div",{id:"debug-info"});return Object.keys(e).forEach((a=>{const n=e[a];t.append(p.create("p",{textContent:`${a}: ${n}`}))})),t}static#h(a){const n=t.getStorageItem(e.STORAGE_KEYS.UPDATE_STATUS),s=t.getStorageItem(e.STORAGE_KEYS.STATS_DATA),r=t.getStorageItem(e.STORAGE_KEYS.USER_CONFIG);return{scriptVersion:GM.info.script.version,defaultConfigVersion:e.DEFAULT_CONFIG.configVersion,currentConfigVersion:r.configVersion,statsDataCount:`${Object.keys(s).length} Players`,statsUpdateStatus:n.status,statsUpdateTimestamp:new Date(n.timestamp).toISOString(),executionTime:`${a}ms`}}}class g{static execute(){const e=g.#m(),t=g.#y(e);document.querySelector("#settings-interface-details").lastChild.after(t)}static#y(e){const t=p.create("div",{id:"debug-log"});return e.forEach((e=>{t.append(p.create("p",{textContent:`${e}`}))})),t}static#m(){return t.getStorageItem(e.STORAGE_KEYS.DEBUG_LOG)}}class m{static execute(){document.querySelector("#settings-interface-details").open=!0}}class y{static execute(){document.addEventListener("keydown",(e=>{"e"===e.key&&(location.assign("javascript:syncsys()"),document.querySelector("#gala_sync").value="Synced")}))}}class f{static execute({features:e},t){const a=e.find((e=>"generalsettings"===e.feature));if(!a)return;const n={syncbutton:{Class:y,params:void 0},debugInfo:{Class:h,params:t},debugLog:{Class:g,params:void 0},configOpen:{Class:m,params:void 0}};a.data.forEach((e=>{e.checked&&n[e.key].Class.execute(n[e.key].params)}))}}class b{static inactiveSelector=".galaxy-short-inactive,.galaxy-short-longinactive";constructor([{value:e},{value:t}]){this.inactiveColor=e,this.longInactiveColor=t}execute(e){const t="A"===e.nextElementSibling?.tagName&&"I"===e.nextElementSibling.firstChild?.tagName?e.parentNode.querySelectorAll(b.inactiveSelector):e.querySelectorAll(b.inactiveSelector);t&&t.forEach((e=>{e.style.color=1===t?.length?this.inactiveColor:this.longInactiveColor,e.style.fontWeight="bold"}))}}class v{static coordsRegex=/(?<Gala>[1-4]):(?<Sys>\d{1,3}):(?<Pos>\d{1,2})(?<isMoon>] M)?/g;constructor([{value:e},{value:t},{value:a}],{currentSystem:n,currentGalaxy:s}){this.nearRange=Number.parseInt(e,10),this.minSys=Number.parseInt(t,10),this.maxSys=Number.parseInt(a,10),this.currentSystem=Number.parseInt(n,10),this.currentGalaxy=s}execute(e){const t=this.getTotalRange(),a=v.getCoordsFromToolTip(e.dataset.tooltipContent),n=v.getNearbyCounts(a,t,this.currentGalaxy),s=v.createNearElement(v.formatNearText(n));e.parentNode.append(s)}getCircularNumberRange(e,t){const a=this.maxSys-this.minSys+1;return Array.from({length:(t-e+a)%a},((t,n)=>(e+n-this.minSys)%a+this.minSys))}getTotalRange(){const e=v.getCircularPosition(this.currentSystem-this.nearRange,this.minSys,this.maxSys),t=v.getCircularPosition(this.currentSystem+this.nearRange,this.minSys,this.maxSys);return[...e<=this.currentSystem?this.getCircularNumberRange(e,this.currentSystem):[...this.getCircularNumberRange(e,this.maxSys+1),...this.getCircularNumberRange(this.minSys,this.currentSystem)],...t>=this.currentSystem?this.getCircularNumberRange(this.currentSystem,t+1):[...this.getCircularNumberRange(this.currentSystem,this.maxSys+1),...this.getCircularNumberRange(this.minSys,t+1)]]}static createNearElement(e){const t=p.create("span",{});return t.append(p.create("br",{})),t.append(p.create("span",{textContent:e})),t}static formatNearText(e){return`NearP: ${e.nearPlanets} NearM: ${e.nearMoons}`}static getCircularPosition(e,t,a){const n=a-t+1;return((e-t)%n+n)%n+t}static getCoordsFromToolTip(e){return e.matchAll(v.coordsRegex)}static getCurrentGalaxyAndSystem(){const[e,t]=document.evaluate("//table/tbody/tr/th[contains(text(), 'System ')]",document,null,XPathResult.STRING_TYPE,null).stringValue.split(" ")[1].split(":");return{currentGalaxy:e,currentSystem:t}}static getNearbyCounts(e,t,a){const n=[...e].map((([,e,t,,a])=>({gala:e,sys:t,moon:a})));let s=-1,r=0;return n.forEach((e=>{const n=Number.parseInt(e.sys,10);e.gala===a&&t.includes(n)&&(s++,e.moon&&r++)})),-1===s&&(s=0),{nearPlanets:s,nearMoons:r}}}class S{constructor(e=[],t={}){this.rankRecolorData=Array.isArray(e)?e:[],this.statsInterfaceInstance="object"==typeof t.stats?t.stats:{};const a=Array.isArray(t.rank)?t.rank:[],{value:n="rank",displayName:s="Gesamt"}=a.find((e=>!0===e.checked))||{};this.rankType=n,this.rankDisplayName=s}execute(e){const t=e.childNodes[1].attributes.playerid.value,a=Number.parseInt(t,10);let n;try{n=this.statsInterfaceInstance.getPlayerRank(a,this.rankType)}catch{n=S.userRankFallback(e),this.rankDisplayName="Gesamt"}const s=p.create("span",{}),r=`${this.rankDisplayName}: ${n}`;s.append(p.create("br",{})),s.append(p.create("span",{textContent:r}));const i=this.rankRecolorData.sort(((e,t)=>t.key-e.key)).find((e=>n>=e.key));i&&(s.style.color=i.value),e.parentNode.append(s)}static getRankSelectorData(e){if(!e)return;const t=e.find((e=>"rankSelector"===e.feature));return t&&Object.keys(t).includes("data")&&Array.isArray(t.data)?t.data:void 0}static userRankFallback(e){return e.dataset.tooltipContent.split("</th")[0].split(" ").pop()}}class k{constructor(e){this.userRecolorData=e}execute(e){if(0===e.children.length)return;const t=e.children[0],a=t.textContent.trim(),n=this.userRecolorData.find((e=>e.key===a));n&&(t.style.color=n.value)}}class T{static selector="a.tooltip_sticky > span.galaxy-username";static#e="IteratorModule";constructor({features:e},t){T.#t("Starting feature iterator ","debug"),this.featureMap={rangeInfo:{Class:v,params:v.getCurrentGalaxyAndSystem()},inactiveRecolor:{Class:b,params:void 0},userRecolor:{Class:k,params:void 0},rankRecolor:{Class:S,params:{rank:S.getRankSelectorData(e),stats:t}}},this.invokeFeatures(e),T.#t("Finished running feature iterator","debug")}invokeFeatures(e){const t=[...document.querySelectorAll(T.selector)].map((e=>e.parentNode));e.map((e=>this.featureMap[e.feature]&&e.active?new this.featureMap[e.feature].Class(e.data,this.featureMap[e.feature].params):void 0)).forEach((e=>{e&&t.forEach((t=>e.execute(t)))}))}static#t(e,a,n){t.writeLog(e,a,T.#e,n)}}class x{static async fetchStatsJson(){return new Promise(((t,a)=>{GM.xmlHttpRequest({method:e.HTTP_METHOD,timeout:e.HTTP_REQUEST_TIMEOUT,url:e.STATS_URL,onload:t,onerror:a})}))}}class E{static STATUS_FINISHED="finished";static STATUS_IN_PROGRESS="inProgress";static#s;static#e="StatisticsInterface";statsAvailable=!1;statsData;constructor(){if(E.#s)return E.#s;E.#s=this}getPlayerIDByName(e){return Object.keys(this.statsData).find((t=>this.statsData[t].playerName===e))}getPlayerNameById(e){return this.statsData[e].playerName}getPlayerRank(e,t="rank"){return this.statsData[e][t]}getPlayerRankData(e){return this.statsData[e]}async initialize(){await this.#f()}async#f(){const a=t.getStorageItem(e.STORAGE_KEYS.UPDATE_STATUS),n=t.getStorageItem(e.STORAGE_KEYS.STATS_DATA);Object.keys(n).length>0&&Object.keys(a).length>0&&E.#b(a)?(this.statsData=n,this.statsAvailable=!0,E.#t("StatsData successfully loaded from storage","debug")):(E.#t("StatsData will be refreshed","debug"),await this.#v())}#S(n){const s={timestamp:a.getTimestamp(),status:E.STATUS_IN_PROGRESS};t.setStorageItem(e.STORAGE_KEYS.UPDATE_STATUS,s),E.#t("Parsing StatsData","debug");const r={};n.forEach((({playerId:e,playerName:t,allianceId:a,allianceName:n,rank:s,researchRank:i,buildingRank:c,fleetRank:l,defensiveRank:o})=>{r[e]={playerName:t,allianceId:a,allianceName:n,rank:s,researchRank:i,buildingRank:c,fleetRank:l,defensiveRank:o}})),t.setStorageItem(e.STORAGE_KEYS.STATS_DATA,r),this.statsData=r,this.statsAvailable=!0,s.status=E.STATUS_FINISHED,s.timestamp=a.getTimestamp(),t.setStorageItem(e.STORAGE_KEYS.UPDATE_STATUS,s),E.#t("StatsData was parsed and written to storage","debug")}async#v(){try{const e=await x.fetchStatsJson();200===e.status?this.#k(e):this.#T(e)}catch(e){this.#T(e)}}#T(a){E.#t("Error while downloading StatsData:","warn"),E.#t("Response was:","warn",a);const n=t.getStorageItem(e.STORAGE_KEYS.STATS_DATA)||{};0!==Object.keys(n).length?(E.#t("Old StatsData found in storage","debug"),this.statsData=n,this.statsAvailable=!0):E.#t("No old StatsData found in storage","debug")}#k(e){E.#t("StatsData was successfully downloaded","debug");const t=JSON.parse(e.responseText);E.#t("Starting StatsData parsing","debug"),this.#S(t)}static _resetInstance(){E.#s=void 0}static#b(t){const a=(new Date).getHours(),n=a-a%e.UPDATE_INTERVAL,s=new Date;return s.setHours(n,e.UPDATE_INTERVAL_DELAY,0,0),t.status===E.STATUS_FINISHED&&t.timestamp>s}static#t(e,a,n){t.writeLog(e,a,E.#e,n)}}class D extends u{constructor(e={}){const{attributes:t={},classList:a=[],eventListeners:n={},id:s="",textContent:r=""}=e;super(s,a,t),this.element=document.createElement("button"),this.element.textContent=r,(Array.isArray(n)||Object.keys(n).length>0)&&(Array.isArray(n)?n:[n]).forEach((e=>{e.eventType&&e.callback&&this.addEventListener(e.eventType,e.callback)}))}}class C{static create(e,t={}){const a={addRow:{classList:["add-row-btn"],textContent:"Hinzufügen"},button:{},removeRow:{classList:["remove-row-btn"],textContent:"Löschen"},reset:{classList:["reset-config-btn"],textContent:"Zurücksetzen"},save:{classList:["save-config-btn"],textContent:"Speichern"}}[e];if(a){const e={...a,...t};return new D(e).getElement()}console.error(`Button type '${e}' is not supported.`)}}class I{constructor(e){this.eventType=e,this.wrapperObject=void 0}getWrapper(){return this.wrapperObject}static extractInputData({checked:e,className:t,dataset:a={},id:n,name:s,type:r,value:i}){const{lastvalue:c}=a,l="number"===r?Number.parseInt(i,10):i;return{checked:e,className:t,id:n,lastvalue:"number"===r?Number.parseInt(c,10):c,name:s,type:r,value:l}}static extractInputPairData(e){const t=I.extractParentRowFromCellEvent(e);return I.extractInputPairFromRow(t).map((e=>I.extractInputData(e)))}static extractInputPairFromRow({children:[{firstChild:e},{firstChild:t}]}){return[e,t]}static extractParentRowFromCellEvent({target:{parentElement:{parentElement:e}}}){return e}static refreshLastValue({target:e}){e&&e.dataset&&(e.dataset.lastvalue="checkbox"===e.type||"radio"===e.type?e.checked:e.value)}}const R={ActiveCheckBoxWrapper:{class:class extends I{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{eventType:this.eventType,callback:t=>{const a=I.extractInputData(t.target);e("changeStatus",a),I.refreshLastValue(t);const{target:{parentElement:{nextSibling:n}=t}}=t;n&&n.classList&&(!0===a.checked?n.classList.remove("hidden"):n.classList.add("hidden"))}}}},event:"click"},AddRowButtonWrapper:{class:class extends I{constructor(e,{addRow:t,delButton:a}){super(e),this.wrapperObject=this.buildWrapperObject(t,a)}buildWrapperObject(e,t){return{eventType:this.eventType,callback:a=>{const{target:{parentElement:{children:[,n]}}}=a;e(n,t)}}}},event:"click"},InputPairWrapper:{class:class extends I{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{eventType:this.eventType,callback:t=>{const a=I.extractInputPairData(t);e("changeData",a),I.refreshLastValue(t)}}}},event:"change"},InputWrapper:{class:class extends I{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{eventType:this.eventType,callback:t=>{const a=I.extractInputData(t.target);e("changeData",a),I.refreshLastValue(t)}}}},event:"change"},RemoveRowButtonWrapper:{class:class extends I{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{eventType:this.eventType,callback:t=>{const a=I.extractParentRowFromCellEvent(t),n=I.extractInputPairData(t);e("removeRow",n),a.remove()}}}},event:"click"},ResetConfigWrapper:{class:class extends I{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{eventType:this.eventType,callback:t=>{const a=I.extractInputData(t.target);e("resetConfig",a)}}}},event:"click"},SaveConfigWrapper:{class:class extends I{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{eventType:this.eventType,callback:t=>{const a=I.extractInputData(t.target);e("saveConfig",a)}}}},event:"click"},SortCheckboxWrapper:{class:class extends I{constructor(e,t){super(e),this.wrapperObject=this.buildWrapperObject(t)}buildWrapperObject(e){return{eventType:this.eventType,callback:t=>{const a=I.extractInputData(t.target);e("changeSorting",a),I.refreshLastValue(t)}}}},event:"click"}};class A{static create(e,t){const a=R[e];if(a){const{class:e,event:n}=a;return new e(n,t).getWrapper()}console.error(`Wrapper type '${e}' is not supported.`)}}class w extends u{constructor(e="text",t={}){const{attributes:a={},checked:n=!1,classList:s=[],eventListeners:r={},id:i="",name:c="",value:l=""}=t;super(i,s,a,r),this.element=document.createElement("input"),this.element.type=e,this.element.name=c,this.element.value=l,"checkbox"!==e&&"radio"!==e||(this.element.checked=n),(Array.isArray(r)||Object.keys(r).length>0)&&(Array.isArray(r)?r:[r]).forEach((e=>{e.eventType&&e.callback&&this.addEventListener(e.eventType,e.callback)}))}}class N{static create(e,t={},a=!1){const n=new w(e,t);return a&&n.addEventListener("keydown",(e=>{e.stopPropagation(),e.stopImmediatePropagation()})),n.getElement()}}class L extends u{constructor(e,t={}){const{id:a="",classList:n=[],attributes:s={},children:r=[],textContent:i=""}=t;super(a,n,s),this.element=document.createElement(e),this.textContent=i,(Array.isArray(r)?r:[r]).forEach((e=>this.append(e)))}}class O{static create(e,t={}){if(!["table","thead","tbody","tr","th","td","tfoot"].includes(e))return void console.error(`TableElement type '${e}' is not supported.`);return new L(e,t).getElement()}}class _{constructor(e,t){this.prefix=`${e.htmlPrefix}`,this.element=O.create("table",{id:`${this.prefix}-tablecontainer`,classList:[`${this.prefix}`,`${e.dataType}`],children:this.#x(e,e.dataType,t)})}getElement(){return this.element}#E(e,t){return[O.create("td",{children:p.create("label",{forId:`${this.prefix}-input-${e.key}`,textContent:e.displayName,title:e.valueDescription,classList:`${this.prefix}-${e.key}-label`})}),O.create("td",{children:[N.create(e.inputType,{name:`${e.key}`,id:`${this.prefix}-input-${e.key}`,value:e.value,classList:`${this.prefix}-${e.key}-input`,attributes:{"data-lastvalue":e.value},eventListeners:A.create("InputWrapper",t),checked:e.checked},!0)]})]}#x(e,t,a){return e.data.map((e=>O.create("tr",{id:`${this.prefix}-row`,classList:`${t} ${t}-row`,children:this.#E(e,a)})))}}class P{constructor(e,t){this.prefix=`${e.htmlPrefix}`,this.keyInputType=e.keyInputType,this.valueInputType=e.valueInputType,this.keyDefault=e.keyDefault,this.valueDefault=e.valueDefault,this.element=O.create("table",{id:`${this.prefix}-tablecontainer`,classList:[`${this.prefix}`,`${e.dataType}`],children:[this.buildTableHeader("valuetable-header",[e.keyDisplayName,e.valueDisplayName,"Löschen"]),this.buildTableBody(e,t),P.buildAddRowButton(this.addDefaultTableRow.bind(this),t)]})}addDefaultTableRow(e,t){e.append(P.buildTableRow(this.prefix,this.keyInputType,this.valueInputType,this.keyDefault,this.valueDefault,t))}buildTableBody(e,t){return O.create("tbody",{id:`${this.prefix}-tablebody`,classList:"valuetable-body",children:e.data.map((a=>P.buildTableRow(this.prefix,e.keyInputType,e.valueInputType,a.key,a.value,t)))})}buildTableHeader(e,t=["","",""],a=["key","value","delete"]){return O.create("thead",{id:`${this.prefix}-tableheader`,classList:"valuetable-header",children:O.create("tr",{id:`${this.prefix}row`,classList:`${e} ${e}-row`,children:[0,1,2].map((e=>O.create("th",{id:`${this.prefix}cell-${a[e]}`,textContent:t[e]})))})})}getElement(){return this.element}static buildAddRowButton(e,t){const a={addRow:e,delButton:t};return C.create("addRow",{eventListeners:A.create("AddRowButtonWrapper",a)})}static buildInputCell(e,t,a,n,s){return O.create("td",{children:[P.buildInputElement(t,{id:`${e}-${a}-${n}`,classList:`${e}-${a}`,name:`${a}input`,value:n},s)]})}static buildInputElement(e,{name:t,value:a,id:n,classList:s},r){return N.create(e,{name:t,value:a,id:n,classList:s,attributes:{"data-lastvalue":a},eventListeners:A.create("InputPairWrapper",r)},!0)}static buildRemoveRowButton(e){return C.create("removeRow",{eventListeners:A.create("RemoveRowButtonWrapper",e)})}static buildTableRow(e,t,a,n,s,r){return O.create("tr",{children:P.buildTableRowCells(e,t,a,n,s,r)})}static buildTableRowCells(e,t,a,n,s,r){return[P.buildInputCell(e,t,"key",n,r),P.buildInputCell(e,a,"value",s,r),O.create("td",{children:[P.buildRemoveRowButton(r)]})]}}class F{static create(e,t){switch(e.dataType){case"ValueTable":return new P(e,t).getElement();case"ValueList":return new _(e,t).getElement();default:console.error(`DataType '${e.dataType}' is not supported.`)}}}class ${constructor(e,t){this.prefix=`${e.htmlPrefix}`,this.baseClass="feature-body",this.element=p.create("div",{id:`${this.prefix}-body-container`,classList:`${this.baseClass}-container`}),e.active||this.element.classList.add("hidden"),this.element.append(F.create(e,t))}getElement(){return this.element}}class U{constructor(e,t){this.prefix=`${e.htmlPrefix}-header-`,this.baseClass="feature-header",this.element=p.create("div",{id:`${this.prefix}container`,classList:[`${this.baseClass}-container`]}),this.element.append(p.create("p",{id:`${this.prefix}title`,textContent:e.displayName,classList:`${this.baseClass}-title`,attributes:{title:e.description}})),this.element.append(p.create("br",{})),this.element.append(p.create("label",{forId:`${this.prefix}-status-checkbox`,textContent:"Aktiv:"})),this.element.append(N.create("checkbox",{checked:e.active,name:`${this.prefix}status-checkbox`,id:`${this.prefix}status-checkbox`,classList:[`${this.baseClass}-statusCheckbox`],attributes:{"data-lastvalue":e.active},eventListeners:A.create("ActiveCheckBoxWrapper",t)})),e.sortData&&(this.element.append(p.create("label",{forId:`${this.prefix}sort-checkbox`,textContent:"Sortieren:"})),this.element.append(N.create("checkbox",{checked:e.sortData,name:`${this.prefix}sort-checkbox`,id:`${this.prefix}sort-checkbox`,classList:[`${this.baseClass}-sortCheckbox`],attributes:{"data-lastvalue":e.active},eventListeners:A.create("SortCheckboxWrapper",t)})))}getElement(){return this.element}}class G{static create(e,t){const a=p.create("div",{classList:"feature-settings-container",id:`${e.htmlPrefix}settings-container`}),n=new U(e,t),s=new $(e,t);return a.append(n.getElement()),a.append(s.getElement()),a}}class j{constructor(e){const t=e.getCurrentConfig(),a=e.getActionCallback(),{features:n,userInterface:{title:s}}=t;this.element=p.create("div",{id:"settings-interface-wrapper"});const r=p.create("details",{id:"settings-interface-details"}),i=p.create("summary",{id:"settings-interface-summary"});i.textContent=s;const c=n.map((e=>G.create(e,a)));r.append(i),c.map((e=>r.append(e)));const l=p.create("div",{id:"settings-interface-footer"}),o=C.create("save",{id:"save-button",textContent:"Speichern",classList:"settings-save-button",eventListeners:A.create("SaveConfigWrapper",a)}),u=C.create("reset",{id:"reset-button",textContent:"Zurücksetzen",classList:"settings-reset-button",eventListeners:A.create("ResetConfigWrapper",a)});l.append(o),l.append(u),r.append(l),this.element.append(r)}getElement(){return this.element}}class V{constructor(e){this.SettingsInterface=new j(e).getElement(),this.galaxyTable=document.querySelector(".table569"),this.SettingsInterface=V.#D(this.SettingsInterface,this.galaxyTable),V.#C(e.getCurrentConfig().userInterface.css),this.galaxyTable.after(this.SettingsInterface)}static#C(e){GM.addStyle(e)}static#D(e,t){const a=window.getComputedStyle(t),n=e;return n.style.margin=a.margin,n.style.alignSelf=a.alignSelf,n.style.width=a.width,n}}class W{static async run(){const e=Date.now();t.writeLog("Starting script","info","Main");const a=new o,n=new E;await n.initialize();new V(a),new T(a.getCurrentConfig(),n);f.execute(a.getCurrentConfig(),e),t.writeLog("Finished script","info","Main")}}"undefined"!=typeof process&&void 0!==process.env.JEST_WORKER_ID||W.run()})();